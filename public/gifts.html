<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presentes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <style>
        .present-box {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            background-color: #fff;
        }
        .present-box img {
            max-width: 64px;
            margin-right: 20px;
        }
        .checkbox {
            margin-left: auto;
        }
        .checkbox.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="title">Selecione os presentes:</h2>

        <div class="present-box" id="present1">
            <div class="media-left">
                <figure class="image is-64x64">
                    <img src="https://http2.mlstatic.com/D_NQ_NP_970085-MLA50595311592_072022-O.webp" alt="Imagem Presente 1">
                </figure>
            </div>
            <div class="media-content">
                <div class="content" id="present1-description">
                    <p><strong>Presente 1</strong> <small>Marca A</small></p>
                    <p>Descrição do Presente 1.</p>
                </div>
                <label class="checkbox">
                    <input type="checkbox" name="gifts" value="1" id="presente1">
                    <span>Selecionar este presente</span>
                </label>
            </div>
        </div>

        <div class="present-box" id="present2">
            <div class="media-left">
                <figure class="image is-64x64">
                    <img src="https://http2.mlstatic.com/D_NQ_NP_970085-MLA50595311592_072022-O.webp" alt="Imagem Presente 2">
                </figure>
            </div>
            <div class="media-content">
                <div class="content" id="present2-description">
                    <p><strong>Presente 2</strong> <small>Marca B</small></p>
                    <p>Descrição do Presente 2.</p>
                </div>
                <label class="checkbox">
                    <input type="checkbox" name="gifts" value="2" id="presente2">
                    <span>Selecionar este presente</span>
                </label>
            </div>
        </div>

        <div class="present-box" id="present3">
            <div class="media-left">
                <figure class="image is-64x64">
                    <img src="https://http2.mlstatic.com/D_NQ_NP_970085-MLA50595311592_072022-O.webp" alt="Imagem Presente 3">
                </figure>
            </div>
            <div class="media-content">
                <div class="content" id="present3-description">
                    <p><strong>Presente 3</strong> <small>Marca C</small></p>
                    <p>Descrição do Presente 3.</p>
                </div>
                <label class="checkbox">
                    <input type="checkbox" name="gifts" value="3" id="presente3">
                    <span>Selecionar este presente</span>
                </label>
            </div>
        </div>

        <div class="present-box" id="present4">
            <div class="media-left">
                <figure class="image is-64x64">
                    <img src="https://http2.mlstatic.com/D_NQ_NP_970085-MLA50595311592_072022-O.webp" alt="Imagem Presente 4">
                </figure>
            </div>
            <div class="media-content">
                <div class="content" id="present4-description">
                    <p><strong>Presente 4</strong> <small>Marca D</small></p>
                    <p>Descrição do Presente 4.</p>
                </div>
                <label class="checkbox">
                    <input type="checkbox" name="gifts" value="4" id="presente4">
                    <span>Selecionar este presente</span>
                </label>
            </div>
        </div>

        <button class="button is-primary" onclick="saveSelections()">Salvar</button>
        <button class="button is-light" onclick="clearSelections()">Limpar</button>
    </div>

    <script>
        async function saveSelections() {
            const username = getUsernameFromUrl();

            const selections = {
                presente1: { selected: document.getElementById('presente1').checked, user: username },
                presente2: { selected: document.getElementById('presente2').checked, user: username },
                presente3: { selected: document.getElementById('presente3').checked, user: username },
                presente4: { selected: document.getElementById('presente4').checked, user: username }
            };

            try {
                const response = await fetch('/get-selections');
                const currentData = await response.json();

                for (const key in selections) {
                    if (!document.getElementById(key).disabled) {
                        currentData[key] = selections[key];
                    }
                }

                const saveResponse = await fetch('/save-selections', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentData)
                });

                if (!saveResponse.ok) {
                    throw new Error('Erro ao salvar seleções');
                }

                for (const key in selections) {
                    const checkbox = document.getElementById(key);
                    if (selections[key].selected && !checkbox.disabled) {
                        checkbox.disabled = true;
                        checkbox.nextElementSibling.textContent = `${username} selecionou este presente`;
                    }
                }
            } catch (error) {
                console.error('Erro ao salvar seleções:', error);
            }
        }

        async function clearSelections() {
            const username = getUsernameFromUrl();

            try {
                const response = await fetch('/get-selections');
                const data = await response.json();

                for (const key in data) {
                    if (data[key].user === username) {
                        data[key] = { selected: false, user: null };
                    }
                }

                const saveResponse = await fetch('/save-selections', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!saveResponse.ok) {
                    throw new Error('Erro ao limpar seleções');
                }

                for (const key in data) {
                    const checkbox = document.getElementById(key);
                    if (data[key].user === null && checkbox.disabled) {
                        checkbox.disabled = false;
                        checkbox.checked = false;
                        checkbox.nextElementSibling.textContent = 'Selecionar este presente';
                    }
                }
            } catch (error) {
                console.error('Erro ao limpar seleções:', error);
            }
        }

        async function loadSelections() {
            try {
                const response = await fetch('/get-selections');
                const data = await response.json();

                for (const key in data) {
                    const checkbox = document.getElementById(key);
                    checkbox.checked = data[key].selected || false;
                    if (data[key].selected) {
                        checkbox.disabled = true;
                        checkbox.nextElementSibling.textContent = `${data[key].user} selecionou este presente`;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar seleções:', error);
            }
        }

        function getUsernameFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('username');
        }

        window.onload = loadSelections;
    </script>
</body>
</html>
